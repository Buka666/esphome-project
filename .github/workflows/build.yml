name: ESPHome Build & Release

on:
  push:
    paths:
      - "devices/**"
      - "packages/**"
      - ".github/workflows/build.yml"
    tags:
      - "v*"
  pull_request:
    paths:
      - "devices/**"
      - "packages/**"
      - ".github/workflows/build.yml"
  workflow_dispatch:

concurrency:
  group: esphome-build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set build version
        id: version
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF_NAME}"
          else
            VERSION="0.0.${GITHUB_RUN_NUMBER}-${GITHUB_SHA::7}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "ESPHOME_BUILD_VERSION=${VERSION}" >> "$GITHUB_ENV"

      - name: Install ESPHome
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install esphome

      - name: Create devices/secrets.yaml from GitHub Secrets
        env:
          WIFI_SSID: ${{ secrets.WIFI_SSID }}
          WIFI_PASSWORD: ${{ secrets.WIFI_PASSWORD }}
          API_ENCRYPTION_KEY: ${{ secrets.API_ENCRYPTION_KEY }}
          OTA_PASSWORD: ${{ secrets.OTA_PASSWORD }}
        run: |
          set -euo pipefail

          : "${WIFI_SSID:?Missing GitHub secret WIFI_SSID}"
          : "${WIFI_PASSWORD:?Missing GitHub secret WIFI_PASSWORD}"
          : "${API_ENCRYPTION_KEY:?Missing GitHub secret API_ENCRYPTION_KEY}"
          : "${OTA_PASSWORD:?Missing GitHub secret OTA_PASSWORD}"

          cat > devices/secrets.yaml <<SECRETS
          wifi_ssid: "$WIFI_SSID"
          wifi_password: "$WIFI_PASSWORD"
          api_encryption_key: "$API_ENCRYPTION_KEY"
          ota_password: "$OTA_PASSWORD"
          SECRETS

      - name: Validate and compile configs
        run: |
          set -euo pipefail
          shopt -s nullglob
          compiled_any=0
          for cfg in devices/*.yaml; do
            case "$cfg" in
              devices/secrets.yaml|devices/secrets.yaml.example) continue ;;
            esac
            compiled_any=1
            echo "Validating $cfg"
            python -m esphome config "$cfg"
            echo "Compiling $cfg"
            python -m esphome compile "$cfg"
          done

          if [ "$compiled_any" -eq 0 ]; then
            echo "No device configs found in devices/*.yaml (excluding secrets files)."
            exit 1
          fi

      - name: Collect firmware artifacts
        run: |
          set -euo pipefail
          mkdir -p dist

          search_roots=(build devices/build .esphome/build)
          existing_roots=()
          for root in "${search_roots[@]}"; do
            if [ -d "$root" ]; then
              existing_roots+=("$root")
            fi
          done

          if [ ${#existing_roots[@]} -eq 0 ]; then
            echo "No build directories found. Checked: ${search_roots[*]}"
            echo "Check compile step output and esphome build_path settings."
            exit 1
          fi

          bins=()
          for root in "${existing_roots[@]}"; do
            while IFS= read -r -d '' bin; do
              bins+=("$bin")
            done < <(find "$root" -type f \( -name "firmware.bin" -o -name "firmware*.bin" \) -print0)
          done

          if [ ${#bins[@]} -eq 0 ]; then
            echo "No firmware binaries were found under: ${existing_roots[*]}"
            for root in "${existing_roots[@]}"; do
              echo "--- files in $root (maxdepth 5) ---"
              find "$root" -maxdepth 5 -type f | sed -n '1,200p' || true
            done
            exit 1
          fi

          for bin in "${bins[@]}"; do
            rel="$bin"
            rel="${rel#./}"
            safe_name="${rel//\//-}"
            target="dist/${safe_name}"
            cp "$bin" "$target"
            echo "Collected $target"
          done

      - name: Generate OTA manifest files
        run: |
          set -euo pipefail
          shopt -s nullglob
          for bin in dist/*.bin; do
            name="$(basename "$bin" .bin)"
            cat > "dist/${name}.json" <<JSON
          {
            "name": "${name}",
            "version": "${{ steps.version.outputs.version }}",
            "builds": [
              {
                "chipFamily": "ESP32-C3",
                "parts": [
                  {
                    "path": "${name}.bin",
                    "offset": 0
                  }
                ]
              }
            ]
          }
          JSON
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esphome-firmware-${{ steps.version.outputs.version }}
          path: dist/**
          if-no-files-found: error

      - name: Publish GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            dist/*.bin
            dist/*.json

      - name: Cleanup generated secrets file
        if: always()
        run: rm -f devices/secrets.yaml
