name: ESPHome Build & Release

on:
  push:
    branches:
      - "main"
      - "master"
    paths:
      - "devices/**"
      - "packages/**"
      - ".github/workflows/build.yml"
      - "README.md"
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - "main"
      - "master"
    paths:
      - "devices/**"
      - "packages/**"
      - ".github/workflows/build.yml"
  workflow_dispatch:
concurrency:
  group: esphome-build-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set build version
        id: version
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF_NAME}"
          elif [[ "${GITHUB_EVENT_NAME}" == "pull_request" ]]; then
            VERSION="pr-${GITHUB_EVENT_NUMBER}-${GITHUB_SHA::7}"
          else
            last_tag="$(git tag -l 'v0.0.*' --sort=-v:refname | head -n1)"
            if [[ -n "$last_tag" ]]; then
              last_num="${last_tag#v0.0.}"
              next_num=$((last_num + 1))
            else
              next_num=1
            fi
            VERSION="v0.0.${next_num}"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "ESPHOME_BUILD_VERSION=${VERSION}" >> "$GITHUB_ENV"

      - name: Install ESPHome
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install esphome

      - name: Create devices/secrets.yaml from GitHub Secrets
        env:
          WIFI_SSID: ${{ secrets.WIFI_SSID }}
          WIFI_PASSWORD: ${{ secrets.WIFI_PASSWORD }}
          API_ENCRYPTION_KEY: ${{ secrets.API_ENCRYPTION_KEY }}
          OTA_PASSWORD: ${{ secrets.OTA_PASSWORD }}
        run: |
          set -euo pipefail

          : "${WIFI_SSID:?Missing GitHub secret WIFI_SSID}"
          : "${WIFI_PASSWORD:?Missing GitHub secret WIFI_PASSWORD}"
          : "${API_ENCRYPTION_KEY:?Missing GitHub secret API_ENCRYPTION_KEY}"
          : "${OTA_PASSWORD:?Missing GitHub secret OTA_PASSWORD}"

          cat > devices/secrets.yaml <<SECRETS
          wifi_ssid: "$WIFI_SSID"
          wifi_password: "$WIFI_PASSWORD"
          api_encryption_key: "$API_ENCRYPTION_KEY"
          ota_password: "$OTA_PASSWORD"
          SECRETS

      - name: Validate and compile configs
        run: |
          set -euo pipefail
          shopt -s nullglob
          compiled_any=0
          for cfg in devices/*.yaml; do
            case "$cfg" in
              devices/secrets.yaml|devices/secrets.yaml.example) continue ;;
            esac
            compiled_any=1
            echo "Validating $cfg"
            python -m esphome -s firmware_version "${ESPHOME_BUILD_VERSION}" config "$cfg"
            echo "Compiling $cfg"
            python -m esphome -s firmware_version "${ESPHOME_BUILD_VERSION}" compile "$cfg"
          done

          if [ "$compiled_any" -eq 0 ]; then
            echo "No device configs found in devices/*.yaml (excluding secrets files)."
            exit 1
          fi

      - name: Collect firmware artifacts
        run: |
          set -euo pipefail
          mkdir -p dist

          bins=()
          while IFS= read -r -d '' bin; do
            bins+=("$bin")
          done < <(find . -type f -name "firmware*.bin"             -not -path "./dist/*"             -not -path "./.git/*"             -print0)

          if [ ${#bins[@]} -eq 0 ]; then
            echo "No firmware binaries were found in workspace after compile."
            echo "Checked recursively from repository root (excluding dist/.git)."
            echo "Top-level directories:"
            find . -maxdepth 2 -type d | sed -n '1,200p'
            exit 1
          fi

          for bin in "${bins[@]}"; do
            env_name="$(basename "$(dirname "$bin")")"
            file_name="$(basename "$bin")"
            target="dist/${env_name}-${file_name}"

            if [ -e "$target" ]; then
              suffix="$(echo -n "$bin" | sha1sum | cut -c1-8)"
              target="dist/${env_name}-${suffix}-${file_name}"
            fi

            cp "$bin" "$target"
            echo "Collected $target"
          done

      - name: Generate OTA manifest files
        run: |
          set -euo pipefail
          shopt -s nullglob

          mapfile -t factory_bins < <(find dist -maxdepth 1 -type f -name '*-firmware.factory.bin' | sort)
          if [ ${#factory_bins[@]} -eq 0 ]; then
            mapfile -t factory_bins < <(find dist -maxdepth 1 -type f -name '*-firmware.bin' | sort)
          fi

          if [ ${#factory_bins[@]} -eq 0 ]; then
            echo "No firmware binaries suitable for OTA manifest were found in dist/."
            exit 1
          fi

          for bin in "${factory_bins[@]}"; do
            file_name="$(basename "$bin")"
            env_name="${file_name%-firmware.factory.bin}"
            if [[ "$env_name" == "$file_name" ]]; then
              env_name="${file_name%-firmware.bin}"
            fi

            cat > "dist/${env_name}.json" <<JSON
          {
            "name": "${env_name}",
            "version": "${{ steps.version.outputs.version }}",
            "builds": [
              {
                "chipFamily": "ESP32-C3",
                "ota": {
                  "path": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/${file_name}",
                  "md5": "$(md5sum "$bin" | cut -d" " -f1)",
                  "release_url": "https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
                }
              }
            ]
          }
          JSON
            echo "Generated manifest dist/${env_name}.json -> ${file_name}"
          done

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esphome-firmware-${{ steps.version.outputs.version }}
          path: dist/**
          if-no-files-found: error

      - name: Create/update tag from compile
        if: github.event_name != 'pull_request' && !startsWith(github.ref, 'refs/tags/')
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f "${{ steps.version.outputs.version }}"
          git push -f origin "refs/tags/${{ steps.version.outputs.version }}"

      - name: Publish GitHub Release
        if: github.event_name != 'pull_request'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          generate_release_notes: true
          overwrite_files: true
          files: |
            dist/*.bin
            dist/*.json

      - name: Cleanup generated secrets file
        if: always()
        run: rm -f devices/secrets.yaml
